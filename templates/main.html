{% extends 'base.html' %} {% block styles %} {{super()}}
<link
  rel="stylesheet"
  type="text/css"
  href="{{url_for('.static', filename='css/style.css')}}"
/>
{% endblock %} {% block navbar %}
<div class="container">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Peppol&PDF Builder</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
          </li>
        </ul>
        <form class="d-flex">
          <input
            class="form-control me-2"
            type="search"
            placeholder="Search"
            aria-label="Search"
          />
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
      </div>
    </div>
  </nav>
  {% endblock %} {% block content %}
  <div class="jumbotron p-4 text-white">
    <div class="container">
      <h1 class="display-3">ã“ã‚“ã«ã¡ã¯!</h1>
      <p class="lead h2 pb-2">
        ã“ã®ã‚µã‚¤ãƒˆã¯Peppolã®ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒ³ãƒœã‚¤ã‚¹ã¨è«‹æ±‚æ›¸PDFã‚’èª°ã§ã‚‚ã‹ã‚“ãŸã‚“ã«ã¤ãã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®ã§ã™ã€‚
      </p>
      <a
        class="btn btn-outline-primary btn-lg"
        href="https://docs.peppol.eu/poac/jp/"
        role="button"
        >JP PINTã®ä»•æ§˜ã¯ã“ã¡ã‚‰</a
      >
    </div>
  </div>

  <div class="alert alert-success m-3" role="alert">
    <h3 class="alert=heading">What's New</h3>
    <p>
      <i class="bi bi-info-circle-fill"></i> 2023.2.19 JP
      PINTã®å„é …ç›®ã«å€¤ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°(æ˜ç´°è¡Œã ã‘å¯¾å¿œã§ãã¦ã„ã¾ã›ã‚“ã‚¹ã‚¤ãƒã‚»ãƒ³ğŸ™‡â€â™‚ï¸)
    </p>
    <hr />
    <p>
      <i class="bi bi-info-circle-fill"></i> 2023.2.11
      æ˜ç´°è¡Œã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ä¿®æ­£
    </p>
    <hr />
    <p><i class="bi bi-info-circle-fill"></i> 2023.1.1 ãƒªãƒªãƒ¼ã‚¹</p>
  </div>

  <div class="row m-2">
    <div class="col-lg-5 h-100">
      <form id="invoice-form" method="post" onsubmit="return false;">
        <div class="border rounded p-2 mb-2">
          <div class="lead mark mb-2">é¡(ãƒ˜ãƒƒãƒ€ãƒ¼)</div>
          <div class="form-group mb-3">
            <label for="invoiceNo" class="form-label">è«‹æ±‚æ›¸ç•ªå·ï¼š</label>
            <input
              id="invoiceNo"
              type="text"
              name="invoiceNo"
              class="form-control"
            />
          </div>
          <div class="form-group mb-3">
            <label for="issueDate" class="form-label">ç™ºè¡Œæ—¥ï¼š</label>
            <input
              id="issueDate"
              type="text"
              name="issueDate"
              class="form-control datepicker"
            />
          </div>
          <div class="form-group mb-3">
            <label for="dealDate" class="form-label">å–å¼•æ—¥ï¼š</label>
            <input
              id="dealDate"
              type="text"
              name="dealDate"
              class="form-control datepicker"
            />
          </div>
          <div class="form-group mb-3">
            <label for="dueDate" class="form-label">æ”¯æ‰•æœŸæ—¥ï¼š</label>
            <input
              id="dueDate"
              type="text"
              name="dueDate"
              class="form-control datepicker"
            />
          </div>
          <div class="form-group mb-3">
            <label for="amount" class="form-label">è«‹æ±‚é¡ï¼š</label>
            <input
              id="amount"
              type="number"
              name="amount"
              class="form-control"
            />
          </div>
        </div>
        <div class="border rounded p-2 mb-2">
          <div class="lead mark mb-2">æ˜ç´°</div>
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th scope="col">å–å¼•å¹´æœˆæ—¥</th>
                  <th scope="col">å“ç›®</th>
                  <th scope="col">æ•°é‡</th>
                  <th scope="col">å˜ä¾¡</th>
                  <th scope="col">ç¨ç‡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="addRow">+ è¿½åŠ </button>
          </div>
        </div>
        <div class="border rounded p-2 mb-2">
          <div class="lead mark mb-2">å£²ã‚Šæ‰‹(å‚µæ¨©è€…)æƒ…å ±</div>
          <div class="form-group">
            <label for="registerNo" class="form-label"
              >é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ç™»éŒ²ç•ªå·ï¼š</label
            >
            <div class="row">
              <div class="col-1 form-start-text">T-</div>
              <input
                id="registerNo"
                class="col-10"
                type="text"
                placeholder="13æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
                maxlength="13"
                pattern="^[0-9]{13}$"
                name="registerNo"
                class="form-control"
              />
              <div class="error">æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
          </div>
          <div class="form-text mb-2">Tã‚’é™¤ãæ•°å­—13æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>

          <div class="form-group mb-3">
            <label for="issuer" class="form-label">è«‹æ±‚å…ƒä¼šç¤¾åï¼š</label>
            <input id="issuer" type="text" name="issuer" class="form-control" />
          </div>
          <div class="form-group mb-3">
            <label for="issuerAddress" class="form-label">è«‹æ±‚å…ƒä½æ‰€ï¼š</label>
            <input
              id="issuerAddress"
              type="text"
              name="issuerAddress"
              class="form-control"
            />
          </div>
          <div class="form-group mb-3">
            <label for="issuerTel" class="form-label">è«‹æ±‚å…ƒé›»è©±ç•ªå·ï¼š</label>
            <input
              id="issuerTel"
              type="tel"
              pattern="\d{2,4}-?\d{2,4}-?\d{3,4}"
              placeholder="æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
              maxlength="11"
              name="issuerTel"
              class="form-control"
            />
            <div class="error">æ­£ã—ã„å½¢å¼ã®é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          </div>
          <div class="form-group mb-3">
            <label for="bank" class="form-label">æŒ¯è¾¼å…ˆéŠ€è¡Œåï¼š</label>
            <input id="bank" type="text" name="bank" class="form-control" />
          </div>
          <div class="form-group mb-3">
            <label for="exampleInputEmail1" class="bBranch">æ”¯åº—åï¼š</label>
            <input
              id="bBranch"
              type="text"
              name="bBranch"
              class="form-control"
            />
          </div>
          <div id="accountType" class="form-group mb-2">
            <label>å£åº§ç¨®åˆ¥ï¼š</label>
            <br />
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="accountType"
                value="normal_deposit"
              />
              <label class="form-check-label" for="inlineRadio1">æ™®é€š</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="accountType"
                value="current_deposit"
              />
              <label class="form-check-label" for="inlineRadio2">å½“åº§</label>
            </div>
          </div>
          <div class="form-group mb-3">
            <label for="accountNo" class="form-label">å£åº§ç•ªå·ï¼š</label>
            <input
              id="accountNo"
              type="number"
              name="accountNo"
              class="form-control"
            />
          </div>
          <div class="form-group mb-3">
            <label for="accountName" class="form-label">å£åº§åç¾©ï¼š</label>
            <input
              id="accountName"
              type="text"
              name="accountName"
              class="form-control"
            />
          </div>
        </div>
        <div class="border rounded p-2 mb-2">
          <div class="lead mark mb-2">æ›¸ã„æ‰‹(å‚µå‹™è€…)æƒ…å ±</div>

          <div class="form-group">
            <label for="buyerNo" class="form-label"
              >é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ç™»éŒ²ç•ªå·ï¼š</label
            >
            <div class="row">
              <div class="col-1 form-start-text">T-</div>
              <input
                id="buyerNo"
                class="col-10"
                type="text"
                placeholder="13æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„"
                maxlength="13"
                pattern="^[0-9]{13}$"
                name="buyerNo"
                class="form-control"
              />
              <div class="error">æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
          </div>
          <div class="form-text mb-2">Tã‚’é™¤ãæ•°å­—13æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
          <div class="form-group mb-3">
            <label for="buyer" class="form-label">è«‹æ±‚å…ˆä¼šç¤¾åï¼š</label>
            <input id="buyer" type="text" name="buyer" class="form-control" />
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-2">ç”Ÿæˆ</button>
        <input
          type="reset"
          id="reset"
          class="btn btn-primary mt-2"
          value="ãƒªã‚»ãƒƒãƒˆ"
        /><br />
        <div class="amazonad">
          <iframe
            sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin"
            style="width: 120px; height: 240px"
            marginwidth="0"
            marginheight="0"
            scrolling="no"
            frameborder="0"
            src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=okazaki060803-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4800590612&linkId=8a104d7a8acdba1ae2280bf7d2ec0743"
          ></iframe>
          <iframe
            sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin"
            style="width: 120px; height: 240px"
            marginwidth="0"
            marginheight="0"
            scrolling="no"
            frameborder="0"
            src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=okazaki060803-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=B0BVTH7YML&linkId=ecb700199181bee497b045484901d807"
          ></iframe>
          <iframe
            sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin"
            style="width: 120px; height: 240px"
            marginwidth="0"
            marginheight="0"
            scrolling="no"
            frameborder="0"
            src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=okazaki060803-22&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4297130025&linkId=a6e355d55149e1e28b4651e9f77269fe"
          ></iframe>
        </div>
      </form>
    </div>
    <div class="col-lg-7">
      <div id="result" class="border border-2">
        ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸPDFãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>
      <div id="jppint" class="border border-2">
        ã“ã“ã«ç”Ÿæˆã•ã‚ŒãŸJP PINTå½¢å¼ã®ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¤ãƒ³ãƒœã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  $('#invoice-form').on('submit', function (e) {
      console.log('submitç™ºç«');
      e.preventDefault();
      // æ˜ç´°ã®å€¤å–å¾— $(".table tbody").children().lengthã§æ˜ç´°è¡Œæ•°ã‚’å–å¾—
      row_num = $(".table tbody").children().length
      console.log(`row_num: ${row_num}`);

      var detailList = [];
      for(let i=1; i<=row_num; i++){
        console.log(`loop${i}`);
        var tmpList = [];
        var detail = $(".detail" + i).serializeArray();
        detail.forEach(elm => {
          Object.keys(elm).forEach(key => {
            if(key=='value'){
              tmpList.push(elm[key]);
            }
          });
        });
        detailList.push(tmpList);
      }

      var formdata = JSON.stringify(
         {
            "fileSpecNo": Math.random().toString(32).substring(2),
            "invoiceNo": $('#invoiceNo').val(),
            "issueDate": $('#issueDate').val(),
            "issuer": $('#issuer').val(),
            "issuerAddress": $('#issuerAddress').val(),
            "issuerTel": $('#issuerTel').val(),
            "amount": $('#amount').val(),
            "dueDate": $('#dueDate').val(),
            "dealDate": $('#dealDate').val(),
            "registerNo": $('#registerNo').val(),
            "bank": $('#bank').val(),
            "bBranch": $('#bBranch').val(),
            "accountType": $('#accountType').val(),
            "accountNo": $('#accountNo').val(),
            "accountName": $('#accountName').val(),
            "detail": detailList,
            "buyer": $('#buyer').val(),
            "buyerNo": $('#buyerNo').val(),
          }
      )
      $.when(
        $.ajax({
          type: "POST",
          url: "/call_from_ajax",
          contentType: "application/json; charset=utf-8",
          data: formdata
        }),
        $.ajax({
          type: "POST",
          url: "/xml/show",
          contentType: "application/json; charset=utf-8",
          data: formdata
        })
      )
          .done(function (received_data, xml_data) {
              // æˆ»ã£ã¦ããŸã®ã¯JSONï¼ˆæ–‡å­—åˆ—ï¼‰
              var dict = JSON.parse(received_data[0]);
              var encoded_string = dict["encoded_string"];
              console.log("encoded_string: " + encoded_string);

              // PDFã‚’è¡¨ç¤º
              $("#result").removeClass("border border-2");
              $("#result").html(
                  '<embed type="application/pdf" width="100%" height="100%" src="data:application/pdf;base64,' +
                  encoded_string +
                  '"><a href="{{url_for('pdfdownload')}}">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>');

              var xml = xml_data[0];
              const parser = new DOMParser();
              const dom = parser.parseFromString(xml, "application/xml");
              // ãƒ«ãƒ¼ãƒˆè¦ç´ ã®åå‰ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¾ã™
              console.log(dom.documentElement.nodeName == "parsererror" ? "ãƒ‘ãƒ¼ã‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ" : dom.documentElement.nodeName);
              const serializer = new XMLSerializer();
              const xmlStr = serializer.serializeToString(xml);
              $("#jppint").text(xmlStr);
          })
          .fail(function () {
              console.log("å¤±æ•—");
          });
  });

  $('.datepicker').datepicker({
      language:'ja',
      format: 'yyyy/mm/dd',
      autoclose: true,
      showButtonPanel: true,
  });

  $(function(){
    $(document).on('click', '.remove', function() {
        console.log('remove function start');
        $(this).parents('tr').remove();
    });
  });
  $('#addRow').click(function(e){
    e.preventDefault();
    // tableã®è¡Œæ•°å–å¾—
    var id = $(".table tbody").children().length + 1;
    console.log(`æ˜ç´°è¡ŒID=${id}`);
    var html = `<tr><td><input id="detail${id}" name="detail${id}" class="detail${id} form-control datepicker" type="text" onclick="(function(){$('#detail${id}').datepicker(); $('#detail${id}').datepicker('show');})()" /></td><td><input id="ItemDetail${id}" name="detail${id}"  class="detail${id} form-control" type="text" /></td><td><input id="quantityDetail${id}" name="detail${id}"  class="detail${id} form-control" type="number" /></td><td><input id="priceDetail${id}" name="detail${id}"  class="detail${id} form-control" type="number" /></td><td><select id="taxrate${id}" class="detail${id} form-control form-control-md" name="taxrate">
                      <option value="10%">10%</option>
                      <option value="8%">8%</option>
                      <option value="ãã‚Œä»¥å¤–">éèª²ç¨ãƒ»ä¸èª²ç¨</option>
                    </select><td><button class="remove">-</button></td></tr>`;
    $('tbody').append(html);
  });
</script>
{% endblock %}
